# Code Refactoring — 共通原則（語言無關）

以下原則適用於 **Java、Python、TypeScript/JavaScript、C#、Go** 等任何語言。重構時應遵守這些共通準則，再依語言慣例撰寫程式。

## 目錄（Table of Contents）

- [核心原則](#核心原則)
- [何時重構 / 何時不重構](#何時重構--何時不重構)
- [Code Smells（共通定義與應對）](#code-smells共通定義與應對)
- [重構技巧（共通模式）](#重構技巧共通模式)
- [安全重構流程（共通）](#安全重構流程共通)
- [Refactoring Checklist（共通）](#refactoring-checklist共通)
- [實作範例](#實作範例)

---

## 核心原則

- **不改變行為**：重構只改結構與可讀性，對外行為與結果不變。
- **小步進行**：一次一種重構，每步都可驗證、可還原。
- **先有保護再動**：有測試或可驗證方式再重構，避免無意改壞行為。

---

## 何時重構 / 何時不重構

### 適合重構的時機

| 時機 | 說明 |
|------|------|
| 加新功能前 | 先讓「改動」變容易，再加功能（make change easy, then make easy change）。 |
| 測試通過後 | 紅—綠—重構（red-green-refactor）：綠燈後再整理程式。 |
| 發現 code smell | 辨識出下列臭味時，排入重構。 |
| Code review 建議 | 審查時指出可讀性、複雜度、重複時，依建議重構。 |

### 不適合重構的時機

| 情況 | 說明 |
|------|------|
| 沒有測試覆蓋 | 無法確認行為不變，風險高；先補測試再重構。 |
| 時程緊且無安全網 | 沒有自動化測試或回滾計畫時，避免大範圍重構。 |
| 程式即將被替換 | 若短期內會整塊替換，重構效益低。 |
| 尚未理解程式在做什麼 | 先讀懂、必要時加註解或小範圍補測試，再重構。 |

---

## Code Smells（共通定義與應對）

不論語言，以下臭味與應對方向一致。

### Long methods / Long functions

- **定義**：一個方法/函式做多件事、過長、難以命名或難以測試。
- **應對**：抽出「做一件事」的區塊成新方法/函式，用描述性名稱；保持單一職責。

### Deeply nested conditionals

- **定義**：多層 if/else 巢狀（箭頭式程式碼），難以閱讀與測試。
- **應對**：用 early return（guard clauses）先處理不成立或邊界情況並回傳，讓主邏輯保持一層或少層巢狀。

### Primitive obsession

- **定義**：到處用基本型別（string、number）表示領域概念，驗證與語意分散重複。
- **應對**：引入 value object / 小物件封裝（如 Email、Phone、Money），在建立時驗證，其餘程式使用型別而非裸 primitives。

### Feature envy

- **定義**：某方法大量使用「其他物件」的資料或 getter，自己的類別資料用得少。
- **應對**：考慮將方法移到「資料所在」的類別（Move Method），或讓該類別提供一個完整行為介面，減少跨物件拉資料。

### 其他常見臭味（共通）

- **重複程式碼**：抽出共用函式/方法或模組，避免複製貼上。
- **過多參數**：用參數物件或 options 結構收納，或拆成較小介面。
- **魔術數字/字串**：用具名常數或列舉表達語意與修改點。
- **過大類別/模組**：依職責拆成多個較小單元。

---

## 重構技巧（共通模式）

以下為語言無關的「做什麼」與「步驟」，實作時用該語言的語法即可。

### Extract Method / Extract Function

- **意圖**：把一段「做一件事」的程式抽成獨立方法/函式。
- **步驟**：  
  1) 找出可命名的一區塊。  
  2) 新增方法/函式，名稱描述該區塊的用途。  
  3) 將區塊移入新方法，必要參數與回傳值明確化。  
  4) 原處改為呼叫新方法。

### Replace Conditional with Polymorphism

- **意圖**：依型別/種類做不同行為時，用多型取代 if/switch。
- **步驟**：  
  1) 定義共通介面/抽象（單一行為方法，如 getArea）。  
  2) 每種型別一個實作類別。  
  3) 呼叫端依介面呼叫，由多型分派，不再依型別分支。

### Introduce Parameter Object

- **意圖**：參數過多時，收成一個參數物件/結構。
- **步驟**：  
  1) 定義結構/類別，欄位對應現有參數（可含巢狀，如 priceRange、sort）。  
  2) 將函式簽名改為接受單一參數物件。  
  3) 呼叫端改為組裝並傳入該物件。

### Replace Magic Numbers / Strings with Named Constants

- **意圖**：讓數字與字串的語意與修改點集中。
- **步驟**：  
  1) 找出代表業務或設定意義的魔術數字/字串。  
  2) 以常數/列舉/設定檔具名（如 MINIMUM_AGE、DISCOUNT_THRESHOLD）。  
  3) 原處改為使用該名稱。

### Move Method

- **意圖**：方法與某類別資料互動遠多於自己類別時，把方法移到該類別。
- **步驟**：  
  1) 在目標類別新增方法，必要時傳入原物件或其部分。  
  2) 原方法改為委派給新方法，或呼叫端改為呼叫新位置。  
  3) 移除原方法。

---

## 安全重構流程（共通）

1. **先有測試**：沒有就補（單元或整合），再開始重構。
2. **小步進行**：一次一種重構，不混入新功能。
3. **每次改動後跑測試**：立刻發現行為變化。
4. **常 commit**：每步可還原，commit message 說明重構內容。
5. **檢查 diff**：確認只改結構與命名，不改行為與邊界條件。

---

## Refactoring Checklist（共通）

- [ ] 重構前測試通過（或已有可驗證方式）
- [ ] 每次改動小且聚焦於單一重構
- [ ] 每次改動後測試通過
- [ ] 僅改結構、命名、組織，不改對外行為
- [ ] 可讀性提升（命名、長度、層級）
- [ ] Commit message 說明重構內容（例如：Extract method X、Replace magic number）

---

## 實作範例

共通原則在具體語言中的寫法，見主檔 [SKILL.md](../SKILL.md)「參考資料」之依語言分檔表；TypeScript 範例：[examples-typescript.md](examples-typescript.md)（Java、Python 等僅語法不同，模式相同）。
